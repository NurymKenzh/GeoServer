
@{
    ViewData["Title"] = "ViewModis";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/lib/ol/ol.css" rel="stylesheet" />
<script src="~/lib/ol/ol.js"></script>
<h2>ViewModis</h2>

<div class="col-md-4">
    <label class="control-label">ModisSource</label>
    @Html.DropDownList("ModisSource", (IEnumerable<SelectListItem>)ViewBag.ModisSource, htmlAttributes: new { @class = "form-control", @id = "ModisSource", @onchange = "ChangeModisSource()" })

    <label class="control-label">ModisProduct</label>
    @Html.DropDownList("ModisProduct", (IEnumerable<SelectListItem>)ViewBag.ModisProduct, htmlAttributes: new { @class = "form-control", @id = "ModisProduct", @onchange = "ChangeModisProduct()" })

    <label class="control-label">ModisDataSet</label>
    <select asp-items="ViewBag.ModisDataSet" name="ModisDataSet" class="form-control" id="ModisDataSet" onchange="ChangeModisDataSet()"></select>

    <label class="control-label">Date</label>
    @{
        DateTime Date = new DateTime();
        Date = DateTime.Today;
    }
    <input asp-for="@Date" id="Date" name="Date" type="date" class="form-control" onchange="ChangeDate()" />
</div>

<div id="map"></div>

<script type="text/javascript">
    var layers = [];
    layers.push(new ol.layer.Tile({
        source: new ol.source.OSM()
    }));
    layers[0].set('name', 'OSM');

    var geoserverPort = '8080',
        geoserverAddress = window.location.hostname;

    var Source_Modis = new ol.source.TileWMS({
        url: 'http://' + geoserverAddress + ':' + geoserverPort + '/geoserver/GeoServer/wms?',
        params: {
            'LAYERS': 'GeoServer:No',
            'VERSION': '1.1.0',
            'FORMAT': 'image/png',
            'TILED': true
        },
        serverType: 'geoserver'
    });
    var Layer_Modis = new ol.layer.Tile({
        source: Source_Modis
    });
    Layer_Modis.setOpacity(0.80);
    layers.push(Layer_Modis);

    var Source_KATO = new ol.source.TileWMS({
        url: 'http://' + geoserverAddress + ':' + geoserverPort + '/geoserver/GeoServer/wms?',
        params: {
            'LAYERS': 'GeoServer:adm1pol',
            'VERSION': '1.1.0',
            'FORMAT': 'image/png',
            'TILED': true
        },
        serverType: 'geoserver'
    });
    var Layer_KATO = new ol.layer.Tile({
        source: Source_KATO
    });
    Layer_KATO.setOpacity(0.80);
    layers.push(Layer_KATO);

    var source = new ol.source.Vector();
    var layer = new ol.layer.Vector({
        source: source
    });

    var map = new ol.Map({
        target: 'map',
        layers: layers,
        view: new ol.View({
            center: ol.proj.fromLonLat([69, 48]),
            zoom: 4
        })
    });
</script>

<script>
    function ChangeModisSource() {
        $.ajax({
            url: '@Url.Action("GetModisProductByModisSource", "GDAL")',
            data: { ModisSource: $('#ModisSource').val() },
            type: 'POST',
            success: function (data) {
                var optionhtml = '';
                $.each(data, function (i) {
                    optionhtml += '<option value="' + data[i]['name'] + '"' +
                        (data[i]['name'] == $('#ModisProduct').val() ? 'selected' : '') +
                        '>' + data[i]['name'] +
                        '</option>';
                });
                $("#ModisProduct").empty();
                $('#ModisProduct').append(optionhtml);
                ChangeModisProduct();
            },
            error: function () {
            }
        });
    };

    function ChangeModisProduct() {
        $.ajax({
            url: '@Url.Action("GetModisDataSets", "GDAL")',
            data: { ModisProduct: $('#ModisProduct').val() },
            type: 'POST',
            success: function (data) {
                var optionhtml = '';
                $.each(data, function (i) {
                    optionhtml += '<option value="' + data[i]['name'] + '"' +
                        (data[i]['indexName'] == $('#File').val() ? 'selected' : '') +
                        '>' + data[i]['indexName'] +
                        '</option>';
                });
                $("#ModisDataSet").empty();
                $('#ModisDataSet').append(optionhtml);
                ChangeModis();
            },
            error: function () {
            }
        });
    };

    function ChangeModisDataSet() {
        ChangeModis();
    };

    function ChangeDate() {
        ChangeModis();
    };

    function ChangeModis() {
        var d = new Date($('#Date').val());

        var start = new Date(d.getFullYear(), 0, 0);
        var diff = d - start;
        var oneDay = 1000 * 60 * 60 * 24;
        var day = Math.floor(diff / oneDay).toString();

        var year = d.getFullYear();

        if (day.length < 3) day = '0' + day;
        if (day.length < 3) day = '0' + day;
        
        var layer_Modis = $('#ModisSource').val();
        layer_Modis += '_' + $('#ModisProduct').val();
        layer_Modis += '_A' + [year, day].join('');
        layer_Modis += '_' + $("#ModisDataSet").val();

        var Source_New = new ol.source.TileWMS({
            url: 'http://' + geoserverAddress + ':' + geoserverPort + '/geoserver/GeoServer/wms?',
            params: {
                'LAYERS': 'GeoServer:' + layer_Modis,
                'VERSION': '1.1.0',
                'FORMAT': 'image/png',
                'TILED': true
            },
            serverType: 'geoserver'
        });
        var l = map.getLayers().getArray()[1];
        l.setSource(Source_New);
    }
</script>